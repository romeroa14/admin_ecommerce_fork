name: Deploy to Hostinger (SSH)

on:
  push:
    branches: [ "main" ]

concurrency:
  group: production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOSTINGER_SSH_HOST }}
          username: ${{ secrets.HOSTINGER_SSH_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_SSH_PORT }}
          script: |
            set -e
            cd ~/public_html

            # Make sure this folder is a git repo on the server the first time:
            # git clone <your_repo_ssh_url> .
            git fetch --all
            git reset --hard origin/main

            # PHP deps (skip if you commit vendor/)
            if [ -f composer.json ]; then
              composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader
            fi

            # Laravel housekeeping
            if [ -f artisan ]; then
              php artisan migrate --force || true
              php artisan optimize:clear
              php artisan config:cache || true
              php artisan route:cache || true
              php artisan view:cache || true
            fi
